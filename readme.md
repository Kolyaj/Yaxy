# Yaxy

Yaxy -- это proxy-сервер для веб-разработчика, подменяющий запрашиваемые ресурсы, следуя простым правилам.

## Формат конфигурационного файла

Конфигурационный файл читается построчно. Пустые строки, строки, начинающиеся на символ `#` и строки неопознанного формата игнорируются.

Правила могут объединяться в секции. Начало секции задаётся строкой в квадратных скобках, содержимое строки может быть любым.

    # Правила вне секций

    [Секция 1]
    # Правила секции 1

    [Секция 2]
    # Правила секции 2

Если имя секции начинается на `#`, то все правила в секции игнорируются.

    # Правила вне секций

    [#Секция 1]
    # Правила секции 1
    # Будут игнорироваться

    [Секция 2]
    # Правила секции 2

## Правила

Правила записываются в виде:

    host.com[/path] => what_to_do
    
Если с хостом или урлом делать ничего не надо, то вместо действия надо написать `$`:

    host.com[/path] => $
    
Например, такое правило добавит для всех ответов с `yandex.st` заголовок `X-Proxy: Yaxy`:
    
    [секция про yandex.st]
    yandex.st => $
    $setResponseHeader X-Proxy: Yaxy

### Простая замена урлов

Правило

    host.com/some/path => another-host.com/another/path

значит буквально следующее: в урлах, начинающихся на `http://host.com/some/path`, заменить это начало на `http://another-host.com/another/path`. Т.е. `host.com/some/path` превратится в `another-host.com/another/path`, `host.com/some/path/foo/bar` превратится в `another-host.com/another/path/foo/bar`, а `host.com/some/` останется без изменений.

### Взятие файлов с файловой системы

Чтобы заматчить урл на файловую систему, используется протокол file://.

    # windows
    host.com/some/path => file://c:/www/host.com
    # linux
    host.com/some/path => file:///home/www/host.com

index-файл для директорий -- index.html. Для приведённого примера по урлу `host.com/some/path` прилетит файл `c:/www/host.com/index.html`, по урлу `host.com/some/path/empty.gif` прилетит файл `c:/www/host.com/empty.gif`.

### Использование data:uri

Если замена настолько простая, что даже файл создавать неохота, можно использовать data:uri

    host.com/some/path => data:text/html;<script type="text/javascript">alert('Привет!');</script>

В этом случае на все урлы, начинающиеся на `host.com/some/path` будет ответ `<script type="text/javascript">alert('Привет!');</script>`.

    host.com/some/path/png => data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEUAAAD///+l2Z/dAAAAM0lEQVR4nGP4/5/h/1+G/58ZDrAz3D/McH8yw83NDDeNGe4Ug9C9zwz3gVLMDA/A6P9/AFGGFyjOXZtQAAAAAElFTkSuQmCC

На урлы, начинающиеся на `host.com/some/path/png` отвечаем картинкой.

## Модификаторы

Строки, начинающиеся на `$` (не считая пробелов в начале строки) являются модификаторами. До первого пробела идёт название модификатора, после -- аргумент. Модификатор относится к тому правилу, после которого он записан. Если модификатор записан в начале файла, до всех правил, то он применяется ко всем правилам. Если модификатор записан в начале секции, то он применяется ко всем правилам в этой секции.

Обратите внимание, модификаторы в начале файла влияют именно на все *правила*, т.е. на запросы, попадающие под эти правила, а не на абсолютно все запросы, проходящие через прокси-сервер.

### Установка и удаление HTTP-заголовков

Есть четыре модификатора для установки заголовков запроса и ответа.

    # Установка заголовка запроса
    $setRequestHeader X-Requested-With: Yaxy

    # Установка заголовка ответа
    $setResponseHeader X-Proxy: Yaxy

    # Удаление заголовка запроса
    $removeRequestHeader Referer

    # Удаление заголовка ответа
    $removeResponseHeader Content-Type


## Как начать использовать

Если у вас до сих пор не установлен NodeJS, [устанавливайте](http://nodejs.org/).

Теперь клонируем или скачиваем исходники Yaxy. Где-нибудь, например, в папке со скачанными исходниками, создайте файл config.txt, в котором и будут лежать правила реврайта. Осталось запустить Yaxy, находясь в папке с config.txt. Если это папка с исходниками, то запустить можно `node .`, или `node index`, или `node index.js`. Если config.txt лежит отдельно от исходников, то `node path/to/yaxy`.

Теперь нужно настроить все свои браузеры, чтобы они ходили в интернет через yaxy. Для этого открываем в браузере настройки proxy-сервера и выставляем там хост 127.0.0.1 (или другой, если yaxy на другой машине) и порт 8558 (по умолчанию).

После правки содержимого config.txt перезапускать Yaxy не надо, изменения подхватятся автоматически.
